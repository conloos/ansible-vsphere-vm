# Ansible Role for create a vm by vSphere.

**summary**

Role to create a vm by vSphere.

This role can be used to create a VM via vShere. There are very, very many options that are provided via the Ansible modules. The goal during development was to have to set as few variables as possible for a VM to be created. Therefore, many variables have been assigned "meaningful" defaults.
This role supports the formats:
* ova (recommended)
* vmdk.
Since the VMDK format can be different from VMWare product, a conversion must be done. For this purpose, this role requires SSH access to the ESX server. Therefore VMDK should not be used if possible!

This role distinguishes between vmdk and ova deployment by `ci_image_name` inkluding the pattern "*.vmdk" or "*.ova".

**!Attention!**

This role supports the data passing of the (user-data, meta-data and implicitly the network-config) through the "properties" section. 
I have not managed to implement the network-config (as described on [readthedocs](https://cloudinit.readthedocs.io/en/latest/topics/datasources/vmware.html#instance-data-and-lazy-networks)) via the meta-data. So I changed the role [ansible-cloud-init](https://github.com/conloos/ansible-cloud-init) so that the network configuration is done through the user-data. I strongly recommend to use  the role [ansible-cloud-init](https://github.com/conloos/ansible-cloud-init), because this role expects (cloud-init) user-data and possibly meta-data to be provided.
A second way is to use a CD with the necessary data (see https://cloudinit.readthedocs.io/en/latest), which can also be generated by the role role [ansible-cloud-init](https://github.com/conloos/ansible-cloud-init). Please note that using a CD is not implemented in this role and you have to extend the role for this purpose.
As a last note: If you do not use cloudinit, you can set the password for the default user: "ubuntu" with the variable: `ova_rescue_password`. If you do not set a password, one will be generated automatically and displayed in the log. At the first login you have to change the password, so the generated password is not a useful way for an end-to-end Ansible solution. :D


**playbook sketch - create vm**
```yaml
- hosts: localhost
  gather_facts: False # If the container/vm isn't create we can't get facts
  pre_tasks:
    # We have to create the container/vm first
    - name: create vm
      ansible.builtin.import_role:
        name: ansible-vsphere-vm
      when: esx is defined and esx|bool

    # Now the containe/vm should exist and we can generate facts
    - name: gather facts
      setup:
  vars:
    cloudinit_fqdn: "test.example.com"
    esxi_host_fqdn: "esx1.example.com"
    vcenter_hostname: "vcenter.example.com"
    vcenter_username: "Admin@vsphere.local"
    vcenter_password: "STRONGPassword"
    vcenter_datacenter: "ha-datacenter"
    vcenter_validate_certs: False
    vm_disk_datastore: "datastore1"
    vm_net_name: "VM Network" 
  tasks: []
```
```bash
$ ansible-playbook main.yml --vault-pass-file .vault-pass.txt --extra-vars "esx=true"
```

## package dependencies
- qemu-utils
- python-is-python3 # added by switching to ubuntu 22.04
- python3-pip
- "pyvmomi=={{pyvmomi_version}}"
- "jmespath=={{jmespath_version}}"

## Keys to implement
| variable | description | mandantory |
| -------- | ----------- | ---------- |
| `cloudinit_fqdn` | FQDN of the system. | **True** |
| `vcenter_hostname` | The hostname or IP address of the vSphere vCenter or ESXi server | **True** |
| `vcenter_username` | The username of the vSphere vCenter or ESXi server. | **True** |
| `vcenter_password` | The password of the vSphere vCenter or ESXi server. | **True** |
| `vcenter_datacenter` | Datacenter to deploy to. | **True** |
| `vcenter_validate_certs` | Allows connection when SSL certificates are not valid. | **True** |
| `vm_disk_datastore` | Specify datastore or datastore cluster to provision virtual machine. | **True** |
| `vm_net_name` | Name of the portgroup or distributed virtual portgroup for this interface. | **True** |
| `vcenter_cluster` | Cluster to deploy to. You have to change that parameter at: 06a_ova_deploy.yml **You have to specify "vcenter_cluster" or "esxi_hostname"** | **True** or "esxi_hostname" |
| `esxi_host_fqdn` | ESXi Host to deploy to. You have to change that parameter at: 06a_ova_deploy.yml **You have to specify "vcenter_cluster" or "esxi_hostname"** | **True** or "vcenter_cluster" |
| `ci_download_url` | URL to download image **default: "https://cloud-images.ubuntu.com"** | **True** if path to image is provided by "vm_path_to_ova" |
| `vm_path_to_ova` | Local FS-path to ova image. | **True** if URL to image is provided by "ci_download_url" |
| `allow_duplicates` | Whether or not to allow duplicate VM names. ESXi allows duplicates, vCenter may not. | False |
| `ci_dist_release_date` | Versiontag to downlad **default: "current"** | False |
| `ci_distname` | Distributions version **default: "current"** | False |
| `ci_image_name` | Image to download eg:"{{ ci_distname }}-server-cloudimg-amd64.ova". Attention currently only **vmdk** and **ova** is supported. Other versions may work. | False |
| `ci_cloudimage_url` | Compound URL (by: {{ ci_download_url }}, {{ ci_dist_release_date }} and {{ ci_image_name }}) to download the image. | False |
| `ci_cloudimage_checksum` | Compound URL to download the checksumm file to check the image. | False |
| `cloudinit_rendering` |  Please use the ansible-cloud-image role. Selection of how the cloud-image data should be rendered. **default: "var"** | False |
| `cloudinit_config['user.user-data']` | Cloud-init user-data | False | 
| `cloudinit_config['user.meta-data']` | Cloud-init meta-data | False |
| `resource_pool` | Resource Pool to deploy to. | False |
| `networks` | Mapping of OVF network name, to the vCenter network name. **default "{u'VM Network':u'{{ vm_net_name }}'}"** | False |
| `vcenter_destination_folder` | Absolute path of folder to place the virtual machine vCenter **default: "Ansible Managed VMs"** | False |
| `vm_state` | Define [state](https://docs.ansible.com/ansible/latest/collections/community/vmware/vmware_guest_powerstate_module.html#parameter-state) of the fresh created vm. This role starts the vm after updating the vm-parameters. **default: "poweredoff"** | False |
| `vm_guestid` | Define the [type](https://docs.vmware.com/en/VMware-HCX/4.2/hcx-user-guide/GUID-D4FFCBD6-9FEC-44E5-9E26-1BD0A2A81389.html) of the fresh created vm. **default: "ubuntu64Guest"** | False |
| `vm_disk_gb` | Disk storage size in gb. **default: 10** | False |
| `vm_disk_type` | Type of [disk](ttps://docs.ansible.com/ansible/latest/collections/community/vmware/vmware_guest_module.html#parameter-disk/type). **default: "thin"** | False |
| `vm_hw_ram_mb` | Amount of memory in MB. **default: 2048** | False |
| `vm_hw_cpu_n` | Number of CPUs for the vm. **default: 2** | False |
| `vm_hw_scsi` | SCSI Controllertype **default: "paravirtual"** | False |
| `vm_net_device_type` | [Virtual network device](https://docs.ansible.com/ansible/latest/collections/community/vmware/vmware_guest_module.html#parameter-networks/device_type). **default: "vmxnet3"** | False |
| `vm_allow_duplicates` | Whether or not to allow duplicate VM names. ESXi allows duplicates, vCenter may not. **default: False** | False |
| `ova_rescue_password` | Set rescue password. If cloud-init fais this is the password for default user ubuntu. See [docs](https://git.launchpad.net/livecd-rootfs/tree/live-build/ubuntu-cpc/hooks.d/base/ovf/ubuntu-ova-v1-cloudcfg-vmdk.tmpl) **default: 'RANDOM'** | False |



## License

see [LICENSE](LICENSE)

...
